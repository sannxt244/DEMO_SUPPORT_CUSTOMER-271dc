<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Manual QR Crop & Scan</title>
    <!-- Th∆∞ vi·ªán qu√©t QR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Th∆∞ vi·ªán gi·∫£i n√©n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #333; color: #fff; padding: 20px; text-align: center; }
        
        /* Khu v·ª±c ƒëi·ªÅu khi·ªÉn */
        .controls { margin-bottom: 15px; background: #444; padding: 10px; border-radius: 8px;}
        input[type="file"] { display: none; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã ·∫£nh v√† v·∫Ω */
        #canvas-wrapper {
            position: relative;
            display: inline-block;
            border: 2px solid #555;
            background: #000;
            cursor: crosshair; /* Con tr·ªè h√¨nh ch·ªØ th·∫≠p */
            overflow: hidden;
            max-width: 100%;
        }
        
        canvas { display: block; max-width: 100%; }

        /* Khung selection (v√πng ch·ªçn) */
        #selection-box {
            position: absolute;
            border: 2px dashed #0f0;
            background: rgba(0, 255, 0, 0.2);
            display: none;
            pointer-events: none; /* ƒê·ªÉ chu·ªôt click xuy√™n qua */
        }

        /* K·∫øt qu·∫£ */
        #status { font-size: 18px; margin: 10px 0; color: yellow; font-weight: bold; min-height: 25px;}
        textarea { width: 90%; height: 200px; margin-top: 10px; padding: 10px; font-family: monospace; border-radius: 5px;}
        
        .part-indicator { display: inline-block; margin: 2px; padding: 5px 10px; background: #555; color: #ccc; border-radius: 3px; font-size: 12px; }
        .part-indicator.have { background: #28a745; color: #fff; font-weight: bold; }
    </style>
</head>
<body>

    <h2>M√ÅY THU: KHOANH V√ôNG TH·ª¶ C√îNG</h2>

    <div class="controls">
        <button class="btn" onclick="document.getElementById('fileInput').click()">1. T·∫£i ·∫£nh ch·ª•p m√†n h√¨nh l√™n</button>
        <input type="file" id="fileInput" accept="image/*" onchange="handleImage(this.files[0])">
        <p style="font-size: 14px; margin-top: 5px; color: #ccc">H∆∞·ªõng d·∫´n: D√πng chu·ªôt K√âO v√† TH·∫¢ bao quanh t·ª´ng m√£ QR ƒë·ªÉ qu√©t.</p>
    </div>

    <div id="status">Vui l√≤ng t·∫£i ·∫£nh...</div>
    <div id="parts-list"></div>

    <!-- Khu v·ª±c v·∫Ω ·∫£nh -->
    <div id="canvas-wrapper">
        <canvas id="mainCanvas"></canvas>
        <div id="selection-box"></div>
    </div>

    <br>
    <textarea id="result" placeholder="K·∫øt qu·∫£ vƒÉn b·∫£n s·∫Ω t·ª± ƒë·ªông gh√©p v√†o ƒë√¢y..."></textarea>
    <br>
    <button class="btn" onclick="resetAll()" style="background: #6c757d; margin-top:10px;">X√≥a l√†m l·∫°i</button>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvas-wrapper');
        const selectionBox = document.getElementById('selection-box');
        const statusDiv = document.getElementById('status');
        const resultArea = document.getElementById('result');
        const partsListDiv = document.getElementById('parts-list');

        let imgElement = new Image();
        let parts = {};
        let totalParts = 0;
        
        // Bi·∫øn x·ª≠ l√Ω k√©o chu·ªôt
        let isDown = false;
        let startX, startY;
        let scale = 1; // T·ªâ l·ªá hi·ªÉn th·ªã n·∫øu ·∫£nh qu√° to

        function handleImage(file) {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imgElement.src = e.target.result;
                imgElement.onload = () => {
                    // Reset
                    canvas.width = imgElement.width;
                    canvas.height = imgElement.height;
                    ctx.drawImage(imgElement, 0, 0);
                    statusDiv.innerText = "H√£y khoanh v√πng m·ªôt m√£ QR!";
                    
                    // T√≠nh scale hi·ªÉn th·ªã (CSS width / Real width)
                    // ·ªû ƒë√¢y ta d√πng tr·ª±c ti·∫øp to·∫° ƒë·ªô th·ª±c c·ªßa canvas ƒë·ªÉ ƒë∆°n gi·∫£n ho√°
                    wrapper.style.width = imgElement.width + "px";
                    wrapper.style.height = imgElement.height + "px";
                }
            };
            reader.readAsDataURL(file);
        }

        // --- S·ª∞ KI·ªÜN CHU·ªòT (V·∫º V√ôNG CH·ªåN) ---
        
        wrapper.addEventListener('mousedown', (e) => {
            isDown = true;
            const rect = wrapper.getBoundingClientRect();
            // L·∫•y to·∫° ƒë·ªô chu·ªôt so v·ªõi canvas
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            
            selectionBox.style.left = startX + 'px';
            selectionBox.style.top = startY + 'px';
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            selectionBox.style.display = 'block';
            selectionBox.style.borderColor = '#0f0'; // M√†u xanh ch·ªù qu√©t
        });

        wrapper.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            const rect = wrapper.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const width = currentX - startX;
            const height = currentY - startY;

            selectionBox.style.width = Math.abs(width) + 'px';
            selectionBox.style.height = Math.abs(height) + 'px';
            
            if (width < 0) selectionBox.style.left = currentX + 'px';
            if (height < 0) selectionBox.style.top = currentY + 'px';
        });

        wrapper.addEventListener('mouseup', (e) => {
            isDown = false;
            // Ti·∫øn h√†nh qu√©t v√πng v·ª´a ch·ªçn
            scanSelection();
            // ·∫®n v√πng ch·ªçn sau 0.5s cho ƒë·∫πp
            setTimeout(() => {
                if(!isDown) selectionBox.style.display = 'none';
            }, 500);
        });

        // --- X·ª¨ L√ù QU√âT QR TRONG V√ôNG CH·ªåN ---
        function scanSelection() {
            // L·∫•y to·∫° ƒë·ªô v√† k√≠ch th∆∞·ªõc t·ª´ selectionBox
            const x = parseInt(selectionBox.style.left);
            const y = parseInt(selectionBox.style.top);
            const w = parseInt(selectionBox.style.width);
            const h = parseInt(selectionBox.style.height);

            if (w < 20 || h < 20) return; // Qu√° b√© kh√¥ng qu√©t

            try {
                // C·∫Øt d·ªØ li·ªáu ·∫£nh t·ª´ Canvas t·∫°i v·ªã tr√≠ ƒë√≥
                const imageData = ctx.getImageData(x, y, w, h);
                
                // G·ª≠i cho th∆∞ vi·ªán jsQR gi·∫£i m√£
                const code = jsQR(imageData.data, w, h, { inversionAttempts: "dontInvert" });

                if (code) {
                    processQRData(code.data);
                    selectionBox.style.borderColor = "blue"; // ƒê·ªïi m√†u b√°o hi·ªáu th√†nh c√¥ng
                } else {
                    statusDiv.innerText = "‚ùå Kh√¥ng t√¨m th·∫•y m√£ QR trong v√πng ch·ªçn. Th·ª≠ l·∫°i!";
                    statusDiv.style.color = "red";
                    selectionBox.style.borderColor = "red";
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- X·ª¨ L√ù D·ªÆ LI·ªÜU ---
        function processQRData(dataStr) {
            // Format mong ƒë·ª£i: Index|Total|CompressedData
            const partsArr = dataStr.split('|');
            if (partsArr.length < 3) {
                statusDiv.innerText = "‚ö†Ô∏è M√£ QR kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng tool n√†y!";
                return;
            }

            const idx = parseInt(partsArr[0]);
            const total = parseInt(partsArr[1]);
            const content = partsArr.slice(2).join('|');

            if (totalParts === 0) {
                totalParts = total;
                renderPartsList();
            }

            // L∆∞u d·ªØ li·ªáu
            if (!parts[idx]) {
                parts[idx] = content;
                statusDiv.innerText = `‚úÖ ƒê√£ nh·∫≠n ph·∫ßn ${idx}/${total}`;
                statusDiv.style.color = "#0f0";
                
                // Update giao di·ªán c√°c √¥ vu√¥ng nh·ªè
                document.getElementById(`part-box-${idx}`).classList.add('have');
                
                // Th·ª≠ gh√©p v√† gi·∫£i m√£
                checkAndDecode();
            } else {
                statusDiv.innerText = `‚ö†Ô∏è Ph·∫ßn ${idx} n√†y ƒë√£ qu√©t r·ªìi!`;
                statusDiv.style.color = "orange";
            }
        }

        function renderPartsList() {
            partsListDiv.innerHTML = "";
            for(let i=1; i<=totalParts; i++) {
                const span = document.createElement("span");
                span.id = `part-box-${i}`;
                span.className = "part-indicator";
                span.innerText = `P${i}`;
                partsListDiv.appendChild(span);
            }
        }

        function checkAndDecode() {
            // Ki·ªÉm tra xem ƒë·ªß ch∆∞a
            const currentCount = Object.keys(parts).length;
            if (currentCount === totalParts) {
                statusDiv.innerText = "üéâ ƒê√É ƒê·ª¶! ƒêANG GI·∫¢I M√É...";
                
                let compressedStr = "";
                for(let i=1; i<=totalParts; i++) {
                    compressedStr += parts[i];
                }

                try {
                    // Gi·∫£i n√©n LZString (t∆∞∆°ng th√≠ch v·ªõi code Sender n√©n tr∆∞·ªõc ƒë√≥)
                    let text = LZString.decompressFromBase64(compressedStr);
                    // N·∫øu kh√¥ng n√©n th√¨ text s·∫Ω l√† null, ta th·ª≠ decode Base64 th∆∞·ªùng
                    if (!text) text = decodeURIComponent(escape(atob(compressedStr)));
                    
                    resultArea.value = text;
                    statusDiv.innerText = "‚úÖ HO√ÄN T·∫§T!";
                } catch (e) {
                    resultArea.value = "L·ªói gi·∫£i m√£: " + e.message;
                }
            }
        }

        function resetAll() {
            parts = {};
            totalParts = 0;
            resultArea.value = "";
            partsListDiv.innerHTML = "";
            statusDiv.innerText = "S·∫µn s√†ng";
        }
    </script>
</body>
</html>
